@page

@model GolfBAIST.Pages.BookingTeeTimeModel

<style>
    .open-slots-bg {
        background: linear-gradient(120deg, #f8fafc 60%, #f1f5fb 100%);
        border: 1px solid #e6eaf0;
    }
    .open-slots-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 32px 24px;
        margin: 0 auto;
        max-width: 1100px;
    }
    .slot-card-wrapper {
        display: flex;
        justify-content: center;
        align-items: stretch;
    }
    .slot-card {
        width: 100%;
        min-width: 220px;
        max-width: 320px;
        margin: 0 auto;
        border-radius: 18px;
        border: 1px solid #e0e0e0;
        box-shadow: 0 4px 24px rgba(44,62,80,0.10);
        background: #fff;
        transition: box-shadow 0.2s, transform 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2.2rem 1.2rem 1.2rem 1.2rem;
        position: relative;
    }
    .slot-card:hover {
        box-shadow: 0 8px 32px rgba(44,62,80,0.18);
        transform: translateY(-4px) scale(1.03);
    }
    .slot-card .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a237e;
        margin-bottom: 1.2rem;
        letter-spacing: 0.5px;
    }
    .copy-slot {
        margin-top: 0.5rem;
        width: 100%;
        font-size: 1.08rem;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(33,150,243,0.08);
        padding: 0.7rem 0;
    }
    .copy-slot:active {
        background: #1976d2;
        color: #fff;
    }
    @@media (max-width: 700px) {
        .open-slots-grid {
            gap: 18px 8px;
            max-width: 100%;
        }
        .slot-card {
            min-width: 0;
            max-width: 100%;
        }
    }
    .flatpickr-calendar.arrowTop:before,
    .flatpickr-calendar.arrowTop:after {
        border: none !important;
    }
    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
        height: 14px;
        width: 14px;
        stroke: #333;
    }
    .flatpickr-calendar {
        font-size: 14px;
        z-index: 9999 !important;
    }
</style>

@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@{
    var basePath = HttpContextAccessor.HttpContext?.Request.PathBase.Value ?? "";
}

@{
    ViewData["Title"] = "Book a Tee Time";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-10">

            <h2 class="mb-4 text-center">Book or Join a Tee Time</h2>

            @if (!string.IsNullOrEmpty(Model.Message))
            {
                <div class="alert alert-info text-center">@Model.Message</div>
            }

            <ul class="nav nav-tabs mb-3" id="bookingTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="book-tab" data-toggle="tab" href="#book" role="tab">Book New</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="open-tab" data-toggle="tab" href="#open" role="tab">View Open Slots</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="join-tab" data-toggle="tab" href="#join" role="tab">Join Existing</a>
                </li>
            </ul>

            <div class="tab-content" id="bookingTabContent">

                <!-- BOOK NEW -->
                <div class="tab-pane fade show active" id="book" role="tabpanel">
                    <form method="post" class="bg-white p-4 rounded shadow-sm">
                        <input type="hidden" asp-for="TeeTime.MemberID" value="@Model.TeeTime.MemberID" />

                        <div class="form-group">
                            <label for="Date">Date</label>
                            <input type="text" class="form-control datepicker" id="Date" name="TeeTime.Date" required />
                        </div>

                        <div class="form-group">
                            <label for="TimeSlot">Select Tee Time</label>
                            <select class="form-control" id="TimeSlot" name="TimeSlot" required></select>
                        </div>

                        <input type="hidden" id="StartTime" name="TeeTime.StartTime" />
                        <input type="hidden" id="EndTime" name="TeeTime.EndTime" />

                        <div class="form-group">
                            <label for="Players">Number of Players</label>
                            <input type="number" class="form-control" id="Players" name="TeeTime.Players" min="1" max="4" required />
                        </div>

                        <div id="additional-members" class="form-group"></div>

                        <div class="form-group">
                            <label for="Phone">Phone</label>
                            <input type="tel" class="form-control" id="Phone" name="TeeTime.Phone" value="@Model.TeeTime.Phone" readonly />
                        </div>


                        <div class="form-group">
                            <label for="Carts">Number of Carts</label>
                            <input type="number" class="form-control" id="Carts" name="TeeTime.Carts" required />
                        </div>

                        <div class="form-group">
                            <label for="EmployeeName">Employee Name (optional)</label>
                            <input type="text" class="form-control" id="EmployeeName" name="TeeTime.EmployeeName" />
                        </div>

                        <button type="submit" class="btn btn-primary btn-block">Book Tee Time</button>
                    </form>
                </div>

                <!-- VIEW OPEN TIME SLOTS -->
                <div class="tab-pane fade" id="open" role="tabpanel">
                    <div class="open-slots-bg p-4 rounded shadow-sm mt-4">
                        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between mb-3">
                            <h4 class="mb-3 mb-md-0 font-weight-bold text-primary" style="letter-spacing:0.5px;">Available Tee Times</h4>
                            <div class="form-group mb-0 ml-md-3" style="min-width:220px;">
                                <label for="CheckDate" class="mb-1">Select Date</label>
                                <input type="text" id="CheckDate" class="form-control datepicker" />
                            </div>
                        </div>
                        <div id="open-slots-result" class="open-slots-grid mt-4"></div>
                    </div>

                </div>

                <!-- JOIN EXISTING TEE TIME -->

                <div class="tab-pane fade" id="join" role="tabpanel">
                    @if (Model.AvailableJoinableTeeTimes.Count > 0)
                    {
                        <table class="table table-bordered table-striped mt-4">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Start</th>
                                    <th>End</th>
                                    <th>Players</th>
                                    <th>Join</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var t in Model.AvailableJoinableTeeTimes)
                                {
                                    <tr>
                                        <td>@t.Date.ToString("yyyy-MM-dd")</td>
                                        <td>@t.StartTime</td>
                                        <td>@t.EndTime</td>
                                        <td>@t.Players</td>
                                        <td style="padding: 0.5rem; text-align: center; vertical-align: middle;">
                                            <form method="post" asp-page-handler="Join" class="compact-form">
                                                <input type="hidden" name="teeTimeId" value="@t.TeeTimeID" />
                                                <button type="submit" class="btn btn-outline-success btn-sm px-3 py-1">Join</button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <p class="mt-4 text-muted text-center">No tee times currently available for joining.</p>
                    }
                </div>
            </div> <!-- Close .tab-content -->
        </div> <!-- Close .col-12.col-lg-10.col-xl-10 -->
    </div> <!-- Close .row -->
</div> <!-- Close .container -->

<!-- Commit date update: whitespace change for git history correction -->

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const basePath = "@basePath";
        function formatTime(h, m) {
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        function populateTimeSlots() {
            const startHour = 6;
            const endHour = 20;
            const interval = 8;
            const $select = $("#TimeSlot").empty();
            for (let h = startHour; h < endHour; h++) {
                for (let m = 0; m < 60; m += interval) {
                    let start = formatTime(h, m);
                    let end = formatTime(h + Math.floor((m + interval) / 60), (m + interval) % 60);
                    $select.append(`<option value="${start}|${end}">${start} - ${end}</option>`);
                }
            }
            $select.trigger("change");
        }
        function initFlatpickr(selector) {
            flatpickr(selector, {
                dateFormat: "Y-m-d",
                defaultDate: "today",
                allowInput: true
            });
        }
        $(document).ready(function () {
            populateTimeSlots();
            initFlatpickr("#Date");
            initFlatpickr("#CheckDate");
            $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                const target = $(e.target).attr("href");
                if (target === "#open") {
                    $("#CheckDate").flatpickr().open();
                }
            });
            $("#TimeSlot").on("change", function () {
                const [start, end] = $(this).val().split("|");
                $("#StartTime").val(start);
                $("#EndTime").val(end);
            });
            $("#Players").on("change", function () {
                const count = parseInt($(this).val());
                const container = $("#additional-members").empty();
                for (let i = 1; i < count; i++) {
                    container.append(`
                        <div class="form-group">
                            <label>Member ID for Player ${i + 1}</label>
                            <input type="number" name="TeeTime.AdditionalMemberIDs[${i - 1}]" class="form-control" required />
                        </div>
                    `);
                }
            });
            $("#CheckDate").on("change", function () {
                const selectedDate = $(this).val();
                $.get(`${basePath}/api/teetimes/available?date=${selectedDate}`, function (data) {
                    let html = '';
                    if (data.length === 0) {
                        html = '<div class="alert alert-warning text-center w-100">No available tee times for this date.</div>';
                    } else {
                        data.forEach(slot => {
                            html += `
                                <div class="slot-card-wrapper">
                                    <div class="slot-card">
                                        <div class="card-title">${slot.startTime} - ${slot.endTime}</div>
                                        <button class="btn btn-primary copy-slot"
                                                data-start="${slot.startTime}"
                                                data-end="${slot.endTime}">
                                            Copy to Booking
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    $("#open-slots-result").html(html);
                    $(".copy-slot").on("click", function () {
                        const start = $(this).data("start");
                        const end = $(this).data("end");
                        const selectedDate = $("#CheckDate").val(); // Grab date
                        $("#StartTime").val(start);
                        $("#EndTime").val(end);
                        $("#TimeSlot").val(`${start}|${end}`);
                        $("#Date").val(selectedDate); // Set the selected date in the booking tab
                        $("#book-tab").tab("show");
                    });
                });
            });
        });
    </script>
}







